# OpenAPI + Orval Setup ‚ú®

## What is This?

The **industry-standard, enterprise-grade** approach to API development:

1. **Zod schemas** ‚Üí Define & validate your API
2. **OpenAPI spec** ‚Üí Auto-generated documentation
3. **Orval** ‚Üí Auto-generated typed TypeScript client

## Benefits

‚úÖ **Single Source of Truth** - Zod schemas drive everything
‚úÖ **Runtime Validation** - Catch bad requests before they hit your DB
‚úÖ **Compile-Time Types** - Full type safety from API ‚Üí client
‚úÖ **Auto-Generated Client** - No manual fetch calls, ever
‚úÖ **Auto-Generated Docs** - OpenAPI spec for Swagger/Postman
‚úÖ **Mobile-Ready** - Same typed client works in Expo

---

## Architecture Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Define Zod Schemas (lib/api/schemas.ts)                     ‚îÇ
‚îÇ    const JoinSessionSchema = z.object({                         ‚îÇ
‚îÇ      playerName: z.string().min(1).max(50)                      ‚îÇ
‚îÇ    })                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Generate OpenAPI Spec (lib/api/openapi.ts)                  ‚îÇ
‚îÇ    registry.registerPath({ ... })                               ‚îÇ
‚îÇ    ‚Üí Served at GET /api/openapi                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Generate Typed Client (pnpm orval)                          ‚îÇ
‚îÇ    ‚Üí lib/api/client.ts (React Query hooks)                      ‚îÇ
‚îÇ    ‚Üí lib/api/model/* (TypeScript types)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Use in Components                                            ‚îÇ
‚îÇ    import { usePostApiSessionsIdPlayers } from '@/lib/api'       ‚îÇ
‚îÇ    const { mutate } = usePostApiSessionsIdPlayers()              ‚îÇ
‚îÇ    mutate({ id: '123', data: { playerName: 'Alice' } })         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Setup Complete! ‚úÖ

### Files Created

```
lib/api/
‚îú‚îÄ‚îÄ schemas.ts              # Zod schemas (validation)
‚îú‚îÄ‚îÄ openapi.ts              # OpenAPI spec generator
‚îú‚îÄ‚îÄ mutator.ts              # Custom fetch wrapper
‚îú‚îÄ‚îÄ client.ts               # ‚Üê Generated by Orval (don't edit)
‚îî‚îÄ‚îÄ model/                  # ‚Üê Generated types (don't edit)

app/api/openapi/
‚îî‚îÄ‚îÄ route.ts                # GET /api/openapi endpoint

orval.config.ts             # Orval configuration
```

### Package.json Scripts to Add

```json
{
  "scripts": {
    "orval": "orval",
    "openapi:generate": "pnpm orval",
    "openapi:watch": "pnpm orval --watch"
  }
}
```

---

## Usage Examples

### Before (Manual)

```typescript
// ‚ùå Untyped, manual validation, error-prone
export const POST = async (request, { params }) => {
  const body = await request.json(); // any
  const { playerName } = body;

  if (!playerName || playerName.trim().length === 0) {
    return NextResponse.json({ error: 'Required' }, { status: 400 });
  }

  if (playerName.length > 50) {
    return NextResponse.json({ error: 'Too long' }, { status: 400 });
  }

  // ... more validation ...
};
```

### After (Zod + OpenAPI)

```typescript
// ‚úÖ Fully typed, validated, one line
export const POST = apiHandler(async (request, { params }) => {
  const { playerName } = await parseBody(request, JoinSessionSchema);

  // playerName is guaranteed to be:
  // - A string
  // - 1-50 characters
  // - Trimmed
  // - Non-empty

  // ... just business logic ...
});
```

---

## Client Usage

### Generate the Client

```bash
# First time
pnpm orval

# Watch mode (regenerates on schema changes)
pnpm orval --watch
```

This creates:
- `lib/api/client.ts` - React Query hooks
- `lib/api/model/*` - TypeScript types

### Use in Components (Next.js)

```typescript
'use client';

import { usePostApiSessionsIdPlayers } from '@/lib/api/client';

export function JoinGameForm({ sessionId }: { sessionId: string }) {
  const { mutate, isPending, error } = usePostApiSessionsIdPlayers();

  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);

    // ‚úÖ Fully typed! TypeScript knows the shape
    mutate({
      id: sessionId,
      data: {
        playerName: formData.get('name') as string,
      },
    }, {
      onSuccess: (player) => {
        // ‚úÖ player is fully typed!
        console.log('Joined as', player.name);
      },
    });
  };

  return (
    <form onSubmit={handleSubmit}>
      <input name="name" required />
      <button disabled={isPending}>
        {isPending ? 'Joining...' : 'Join Game'}
      </button>
      {error && <div>{error.message}</div>}
    </form>
  );
}
```

### Use in Expo App (Same Code!)

```typescript
import { usePostApiSessionsIdPlayers } from '@/lib/api/client';
import { View, TextInput, Button } from 'react-native';

export function JoinGameScreen({ route }) {
  const { sessionId } = route.params;
  const [name, setName] = useState('');
  const { mutate, isPending } = usePostApiSessionsIdPlayers();

  return (
    <View>
      <TextInput value={name} onChangeText={setName} />
      <Button
        title={isPending ? 'Joining...' : 'Join'}
        onPress={() => {
          // ‚úÖ Same typed API!
          mutate({
            id: sessionId,
            data: { playerName: name },
          });
        }}
      />
    </View>
  );
}
```

---

## OpenAPI Documentation

### View the Spec

```bash
# Start dev server
pnpm dev

# View OpenAPI JSON
curl http://localhost:3000/api/openapi
```

### Use with Swagger UI

```bash
# Install swagger-ui-react
pnpm add swagger-ui-react

# Create app/api-docs/page.tsx
import SwaggerUI from 'swagger-ui-react';
import 'swagger-ui-react/swagger-ui.css';

export default function ApiDocs() {
  return <SwaggerUI url="/api/openapi" />;
}
```

Then visit `http://localhost:3000/api-docs`

---

## Validation Examples

### Schema Definition

```typescript
// lib/api/schemas.ts
export const JoinSessionSchema = z.object({
  playerName: z
    .string()
    .min(1, 'Player name is required')
    .max(50, 'Player name must be 50 characters or less')
    .trim()
    .refine((name) => name.length > 0, 'Player name cannot be empty'),
});
```

### Automatic Validation Errors

```bash
# Missing playerName
POST /api/sessions/123/players
{}

# Response: 400
{ "error": "playerName: Player name is required" }

# Too long
POST /api/sessions/123/players
{ "playerName": "a".repeat(51) }

# Response: 400
{ "error": "playerName: Player name must be 50 characters or less" }

# Invalid UUID
POST /api/sessions/123/players
{ "playerId": "not-a-uuid" }

# Response: 400
{ "error": "playerId: Invalid player ID format" }
```

---

## Discriminated Unions (Advanced)

```typescript
// Schema with discriminated union
export const UpdateRoundSchema = z.discriminatedUnion('action', [
  z.object({ action: z.literal('start') }),
  z.object({
    action: z.literal('judge'),
    correct: z.boolean(),
  }),
  z.object({ action: z.literal('reveal') }),
]);

// In route handler
export const PATCH = apiHandler(async (request, { params }) => {
  const body = await parseBody(request, UpdateRoundSchema);

  // ‚úÖ TypeScript knows body.action is 'start' | 'judge' | 'reveal'
  switch (body.action) {
    case 'judge':
      // ‚úÖ TypeScript knows body.correct exists here!
      return judgeAnswer(body.correct);

    case 'start':
      // ‚úÖ TypeScript knows body.correct does NOT exist here
      return startRound();
  }
});
```

---

## Workflow

### 1. Add New Endpoint

```typescript
// 1. Define schema
export const CreatePackSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().optional(),
});

// 2. Register in OpenAPI
registry.registerPath({
  method: 'post',
  path: '/api/packs',
  request: {
    body: {
      content: {
        'application/json': {
          schema: CreatePackSchema,
        },
      },
    },
  },
  responses: { ... },
});

// 3. Generate client
pnpm orval

// 4. Use in component
import { usePostApiPacks } from '@/lib/api/client';
const { mutate } = usePostApiPacks();
```

### 2. Change Existing Endpoint

```typescript
// 1. Update schema
export const JoinSessionSchema = z.object({
  playerName: z.string().min(1).max(50),
  teamId: z.string().uuid().optional(), // ‚Üê Added field
});

// 2. Regenerate client
pnpm orval

// 3. TypeScript shows all places that need updating!
```

---

## Next Steps

1. **Add scripts to package.json**
   ```json
   "orval": "orval",
   "openapi:generate": "pnpm orval"
   ```

2. **Generate the client**
   ```bash
   pnpm orval
   ```

3. **Replace manual fetch calls**
   Use generated hooks instead of `useGameSession`, etc.

4. **Add Swagger UI** (optional)
   For interactive API documentation

5. **Share with Expo**
   Copy `lib/api/` to your Expo project

---

## Summary

You now have:
- ‚úÖ **Runtime validation** with Zod
- ‚úÖ **Compile-time types** with TypeScript
- ‚úÖ **Auto-generated client** with Orval
- ‚úÖ **API documentation** with OpenAPI
- ‚úÖ **Mobile-ready** architecture

This is the **same stack** used by:
- Stripe
- Vercel
- Linear
- Cal.com

üéâ Enterprise-grade API infrastructure complete!
